#!/usr/bin/env bash

# Synopsis:
# Test the track's exercises.
# 
# At a minimum, this file must check if the example/exemplar solution of each 
# Practice/Concept Exercise passes the exercise's tests.
#
# To check this, you usually have to (temporarily) replace the exercise's solution files
# with its exemplar/example files.
#
# If your track uses skipped tests, make sure to (temporarily) enable these tests
# before running the tests.
#
# The path to the solution/example/exemplar files can be found in the exercise's
# .meta/config.json file, or possibly inferred from the exercise's directory name.

# Example:
# ./bin/test

# Verify the Concept Exercises
failures=0
for concept_exercise_dir in ./exercises/concept/*/; do
    if [ -d "$concept_exercise_dir" ]; then
        slug=$(basename "${concept_exercise_dir}")
        echo "Checking ${slug} exercise..."
        mv "${concept_exercise_dir}/${slug}".sql "${concept_exercise_dir}/${slug}"_backup.sql
        cp "${concept_exercise_dir}"/.meta/exemplar.sql "${concept_exercise_dir}/${slug}".sql
        bin/verify-exercise-example "${slug}" "${concept_exercise_dir}" "${concept_exercise_dir}" || (( failures++ ))
        mv -f "${concept_exercise_dir}/${slug}"_backup.sql "${concept_exercise_dir}/${slug}".sql
    fi
done

# Verify the Practice Exercises
for practice_exercise_dir in ./exercises/practice/*/; do
    if [[ -d "$practice_exercise_dir" ]]; then
        slug=$(basename "${practice_exercise_dir}")
        echo "Checking ${slug} exercise..."
        mv "${practice_exercise_dir}/${slug}".sql "${practice_exercise_dir}/${slug}"_backup.sql
        cp "${practice_exercise_dir}"/.meta/example.sql "${practice_exercise_dir}/${slug}".sql
        ./bin/verify-exercise-example "${slug}" "${practice_exercise_dir}" "${practice_exercise_dir}" || (( failures++ ))
        mv -f "${practice_exercise_dir}/${slug}"_backup.sql "${practice_exercise_dir}/${slug}".sql
    fi
done

if (( failures )); then
    echo "${failures} tests failed!"
    exit 1
fi
exit 0
